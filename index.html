<!DOCTYPE html>
<html lang="id" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undangan Fulan & Fulanah</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 1. Pengaturan Ulang dan Dasar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Amiri', serif; 
        }

        body {
            background: #1e1f0d; /* Latar belakang gelap */
            color: #fff;
            overflow-x: hidden;
            text-align: left; /* Default LTR */
        }
        
        /* Mencegah seret gambar */
        img {
            -webkit-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: auto;
            user-select: none;
        }

        /* 2. Layar Sampul (Cover) */
        #cover {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Ganti 'cover-image.jpg' dengan gambar sampul yang sebenarnya */
            background: url('cover-image.jpg') center/cover no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #enterBtn {
            width: 150px;
            cursor: pointer;
            transition: .3s;
        }

        #enterBtn:hover {
            transform: scale(1.05);
        }

        #guestName {
            margin-top: 20px;
            font-size: 20px;
            color: #fff;
        }

        /* 3. Navigasi Bawah */
        #nav {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 5px;
            z-index: 1000;
            direction: ltr; 
        }

        #nav img {
            width: 28px;
            height: 28px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
        }

        /* 4. Bagian Halaman (Sections) */
        #pages {
            display: none;
            scroll-snap-type: y mandatory;
        }

        .section {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
            scroll-snap-align: start;
            overflow: hidden;
        }

        .page-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        /* 5. Hitungan Mundur (Countdown) */
        #countdown {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
        }

        .countBox {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .countBox span {
            font-size: 18px;
            color: #9d8d69;
        }

        .countBox small {
            font-size: 9px;
            margin-top: 1px;
            color: #9d8d69;
        }
        
        /* 6. Galeri Foto */
        .gallery-container {
            width: 90%;
            max-width: 400px;
            overflow-x: scroll;
            white-space: nowrap;
            padding: 10px 0;
            scroll-snap-type: x mandatory;
            -ms-overflow-style: none;
            scrollbar-width: none;
            margin-top: 50px;
            direction: ltr; 
        }

        .gallery-container::-webkit-scrollbar {
            display: none;
        }

        .gallery-grid {
            display: flex;
            gap: 10px;
            padding: 0 10px;
        }

        .gallery-item {
            min-width: 140px;
            height: 180px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #9d8d69;
            flex-shrink: 0;
            scroll-snap-align: center;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 7. Kotak Salin (Donasi/Rekening) */
        .section#page5 {
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .copy-box-container {
            position: absolute;
            left: 17%; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 60px;
            top: 53%;
            transform: translateY(-50%);
        }

        .copy-box {
            width: 55px;
            height: 55px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #9d8d69;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .copy-box .copy-text {
            font-size: 11px;
            font-weight: bold;
            color: #9d8d69;
        }

        .copy-box:active {
            transform: scale(0.95);
        }

        /* 8. Komentar (Formulir dan Daftar) */
        .section#page7 {
            justify-content: flex-start;
            align-items: center;
            padding-top: 150px;
            padding-bottom: 70px;
        }

        #commentsWrapper {
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            border-radius: 10px;
            background: #fff;
            color: #000;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 10;
            text-align: left; 
        }

        .formLabel {
            margin: 5px 0 0;
            font-size: 14px;
            color: #9d8d69;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #9d8d69;
            font-size: 14px;
            margin-bottom: 5px;
            font-family: 'Amiri', serif;
            direction: ltr; 
            text-align: left;
            background: #fff;
            color: #000;
        }
        
        textarea {
            min-height: 80px;
            resize: none;
        }

        button {
            padding: 7px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #9d8d69;
            color: #000;
            font-weight: bold;
            margin-top: 5px;
            transition: background 0.3s;
        }
        
        button:disabled {
            background: #ccc !important;
            color: #555 !important;
            cursor: not-allowed;
        }

        #sendComment {
            margin-bottom: 15px;
        }

        .commentItem {
            border: 1px solid #9d8d69;
            border-radius: 8px;
            padding: 8px;
            background: #fff;
            color: #000;
            font-size: 14px;
            margin-bottom: 8px;
            position: relative;
            direction: ltr; 
            text-align: left;
        }

        .timeInfo {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .replyBtn {
            background: #9d8d69;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 5px;
            border: none;
            font-weight: normal;
        }

        .comment-time {
            font-size: 12px;
            color: #777;
        }

        .reply-form {
            padding-top: 5px;
            border-top: 1px dashed #eee;
            margin-top: 5px;
            direction: ltr; 
            display: none;
        }

        .reply-item {
            border-top: 1px solid #9d8d69;
            padding: 5px 0 0 0;
            margin-top: 5px;
            font-size: 13px;
            direction: ltr; 
            text-align: left;
        }

        .reply-item .reply-text {
            display: block;
            margin-bottom: 3px;
        }

        .reply-item .timeInfo {
            font-size: 10px;
            color: #777;
            text-align: left;
            margin-top: 0;
        }

        /* 9. Footer (Kaki Halaman) */
        #pageFooter {
            width: 100%;
            position: absolute;
            bottom: 50px;
            left: 0;
            padding: 5px 0;
            text-align: center;
            font-size: 15px;
            background: rgba(0, 0, 0, 0.4);
            color: #aaa;
            z-index: 100;
        }

        #pageFooter a {
            color: #9d8d69;
            text-decoration: none;
            font-weight: bold;
        }
    </style>

</head>
<body>
    <div id="cover">
        <img id="enterBtn" src="enter.png" alt="Tombol Masuk">
        <div id="guestName">Kepada Yth: Sara</div>
    </div>

    <div id="nav">
        <img src="icon1.png" data-go="0" alt="Ikon 1">
        <img src="icon2.png" data-go="1" alt="Ikon 2">
        <img src="icon3.png" data-go="2" alt="Ikon 3">
        <img src="icon4.png" data-go="3" alt="Ikon 4">
        <img src="icon5.png" data-go="4" alt="Ikon 5">
        <img src="icon6.png" data-go="5" alt="Ikon 6">
        <img src="icon7.png" data-go="6" alt="Ikon 7">
    </div>

    <div id="pages">

        <div class="section">
            <video class="page-video" src="page1.mp4" muted loop autoplay playsinline></video>
        </div>

        <div class="section" id="page2">
            <video class="page-video" src="page2.mp4" muted loop autoplay playsinline></video>
            <img class="siteImage" src="site.png" style="margin-top:650px;max-width:50%;cursor:pointer;"
                alt="Gambar Peta Lokasi">
        </div>

        <div class="section" id="page3">
            <video class="page-video" src="page3.mp4" muted loop autoplay playsinline></video>

            <div id="countdown">
                <div class="countBox"><span id="d">0</span><small>Hari</small></div>
                <div class="countBox"><span id="h">0</span><small>Jam</small></div>
                <div class="countBox"><span id="m">0</span><small>Menit</small></div>
                <div class="countBox"><span id="s">0</span><small>Detik</small></div>
            </div>
        </div>

        <div class="section">
            <video class="page-video" src="page4.mp4" muted loop autoplay playsinline></video>

            <div class="gallery-container">
                <div class="gallery-grid">
                    <div class="gallery-item"><img src="g1.jpg" alt="Galeri Gambar 1"></div>
                    <div class="gallery-item"><img src="g2.jpg" alt="Galeri Gambar 2"></div>
                    <div class="gallery-item"><img src="g3.jpg" alt="Galeri Gambar 3"></div>
                    <div class="gallery-item"><img src="g4.jpg" alt="Galeri Gambar 4"></div>
                </div>
            </div>
        </div>

        <div class="section" id="page5">
            <video class="page-video" src="page5.mp4" muted loop autoplay playsinline></video>

            <div class="copy-box-container">
                <div class="copy-box" data-num="081234567890">
                    <span class="copy-text">Salin</span>
                </div>
                <div class="copy-box" data-num="085711223344">
                    <span class="copy-text">Salin</span>
                </div>
            </div>
        </div>

        <div class="section">
            <video class="page-video" src="page6.mp4" muted loop autoplay playsinline></video>
        </div>

        <div class="section" id="page7">
            <video class="page-video" src="page7.mp4" muted loop autoplay playsinline></video>

            <div id="commentsWrapper">
                <div class="formLabel">Nama</div>
                <input type="text" id="cName" placeholder="Contoh: Nurul">

                <div class="formLabel">Status Kehadiran</div>
                <select id="cStatus">
                    <option value="">Pilih Status</option>
                    <option value="Hadir">Hadir</option>
                    <option value="Berhalangan">Berhalangan</option>
                </select>

                <div class="formLabel">Ucapan</div>
                <textarea id="cMsg" placeholder="Contoh: Semoga bahagia selalu..."></textarea>

                <button id="sendComment">Kirim</button>
                
                <div id="loadingStatus" style="color:#000; margin-top:10px; font-weight:bold; display:none;">
                    Memuat komentar...
                </div>

                <div id="paginationControls" style="display:flex; justify-content:space-between; margin-top:10px; gap:10px;">
                    <button id="prevBtn" style="flex:1;">
                        < Sebelumnya
                    </button>
                    <button id="nextBtn" style="flex:1;">
                        Berikutnya >
                    </button>
                </div>
                <div id="commentsList"></div>
            </div>

            <div id="pageFooter">
                Created with love by <a href="https://www.instagram.com/alaleefa_?igsh=MW45Z21oM2x0YndjcQ=="
                    target="blank">@alaleefa_</a>/
                <a href='https://api.whatsapp.com/send/?phone=%2B6281287575722&text&type=phone_number&app_absent=0&wame_ctl=1'>081287575722</a>
            </div>

        </div>

    </div>

    <audio id="music" src="music.mp3" loop></audio>

    <script>
        // 游댮游댮游댮 PENTING: GANTI DENGAN URL APPS SCRIPT ANDA 游댮游댮游댮
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0lmshVXZ7H60obrrwqWGFlL416YI8p3XlaewywsI49d-lnuh_eYmrUl9vZBZU407jeA/exec";
        // 游댮游댮游댮 PASTIKAN ANDA MENGGANTI INI 游댮游댮游댮

        // 游릭 KONSTANTA DAN ELEMEN KOMENTAR 游릭
        const COMMENTS_PER_PAGE = 5;
        let currentPage = 1;
        let allComments = [];
        const commentsList = document.getElementById('commentsList');
        const loadingStatus = document.getElementById('loadingStatus');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const cName = document.getElementById('cName');
        const cMsg = document.getElementById('cMsg');
        const cStatus = document.getElementById('cStatus');
        const sendComment = document.getElementById('sendComment');


        /* Kontrol Nama Tamu */
        const guestNameParam = new URLSearchParams(location.search).get('guest') || 'Sara';
        document.getElementById('guestName').innerText = "Kepada Yth: " + guestNameParam;

        /* Kontrol Musik dan Tampilan Halaman */
        enterBtn.onclick = () => {
            cover.style.display = "none";
            pages.style.display = "block";
            nav.style.display = "flex";
            // Mencoba memutar musik
            music.play().catch(e => console.error("Autoplay gagal:", e));

            // Memutar semua video latar belakang
            document.querySelectorAll('.page-video').forEach(v => v.play());
        };

        /* Navigasi Antar Bagian */
        document.querySelectorAll('#nav img').forEach(btn => {
            btn.onclick = () => document.querySelectorAll('.section')[btn.dataset.go]
                .scrollIntoView({
                    behavior: 'smooth'
                });
        });

        /* Buka Peta Google Maps */
        document.querySelector('.siteImage').onclick = () => {
            // Ganti URL Google Maps ini dengan lokasi acara Anda yang sebenarnya
            window.open('https://maps.app.goo.gl/fipYv9RUQYJmwTDq6','_blank'); 
        };

        /* Hitungan Mundur */
        let targetDate = new Date("2026-09-07T00:00:00").getTime(); // Ganti tanggal target
        setInterval(() => {
            let diff = targetDate - Date.now();
            if (diff < 0) diff = 0;
            d.innerText = Math.floor(diff / 86400000);
            h.innerText = Math.floor((diff % 86400000) / 3600000);
            m.innerText = Math.floor((diff % 3600000) / 60000);
            s.innerText = Math.floor((diff % 60000) / 1000);
        }, 1000);

        /* Fungsi Salin Nomor Rekening */
        document.querySelectorAll('.copy-box').forEach(box => {
            box.onclick = () => {
                // Menyalin teks ke clipboard
                navigator.clipboard.writeText(box.dataset.num); 
                box.style.background = "rgba(157,141,105,0.7)";
                box.querySelector('.copy-text').innerText = 'Disalin!';
                setTimeout(() => {
                    box.style.background = "rgba(255,255,255,0.2)";
                    box.querySelector('.copy-text').innerText = 'Salin';
                }, 800);
            };
        });

        // =======================================================================
        // 游 LOGIKA KOMENTAR DAN BALASAN (Google Sheet API) 游
        // =======================================================================

        /**
         * 1. Mendapatkan Komentar dari Google Sheet
         */
        async function getCommentsFromSheet() {
            loadingStatus.style.display = 'block';
            const url = `${APPS_SCRIPT_URL}?action=getComments`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Kesalahan HTTP! status: ${response.status}`);
                }
                
                let commentsData = await response.json();
                
                // Re-struktur data dari Apps Script
                allComments = commentsData.map(c => ({
                    id: c.id,
                    name: c.name,
                    status: c.status,
                    msg: c.comment,
                    time: c.date,
                    parentId: c.replyTo || null,
                    replyToName: c.replyTo || null
                }));
                
            } catch (error) {
                console.error("Gagal mengambil komentar:", error);
                alert("Gagal memuat komentar. Cek koneksi atau Apps Script URL Anda.");
                allComments = [];
            } finally {
                loadingStatus.style.display = 'none';
            }
        }

        /**
         * 2. Menambahkan Komentar/Balasan ke Google Sheet
         */
        async function addCommentToSheet(data) {
            sendComment.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            
            const postData = {
                action: 'addComment',
                name: data.name,
                status: data.status,
                comment: data.msg,
                replyTo: data.parentId || ""
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });
                
                if (!response.ok) {
                    throw new Error(`Kesalahan HTTP! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.result === "success") {
                    // Setelah sukses, muat ulang data dari server
                    await initComments();
                    
                    // Jika ini adalah komentar utama, pindah ke halaman 1 agar komentar baru terlihat
                    if (!data.parentId) {
                        currentPage = 1;
                    }
                } else {
                    alert("Gagal menyimpan komentar: " + (result.message || "Kesalahan tak terduga."));
                }

            } catch (error) {
                console.error("Kesalahan saat menambahkan komentar:", error);
                alert("Gagal mengirim komentar. Cek Apps Script URL.");
            } finally {
                sendComment.disabled = false;
                // Tombol paginasi akan diaktifkan/dinonaktifkan di renderComments()
            }
        }

        /**
         * 3. Fungsi Utama Rendering Komentar dengan Paginasi
         */
        function renderComments() {
            commentsList.innerHTML = "";
            
            // Filter komentar utama dan urutkan (terbaru di atas)
            const mainComments = allComments
                .filter(c => !c.parentId || c.parentId === 'null' || c.parentId === '')
                .sort((a, b) => new Date(b.time) - new Date(a.time));

            const totalMainComments = mainComments.length;
            const totalPages = Math.ceil(totalMainComments / COMMENTS_PER_PAGE);

            // Hitung indeks untuk halaman saat ini
            const startIndex = (currentPage - 1) * COMMENTS_PER_PAGE;
            const endIndex = startIndex + COMMENTS_PER_PAGE;

            // Ambil komentar untuk halaman saat ini
            const commentsToDisplay = mainComments.slice(startIndex, endIndex);

            // --- Kontrol Paginasi ---
            if (totalMainComments > COMMENTS_PER_PAGE) {
                document.getElementById('paginationControls').style.display = 'flex';
                
                // Nonaktifkan tombol 'Sebelumnya' di halaman pertama
                prevBtn.disabled = (currentPage === 1);
                
                // Nonaktifkan tombol 'Berikutnya' di halaman terakhir
                nextBtn.disabled = (currentPage >= totalPages);

            } else {
                // Sembunyikan jika total komentar <= COMMENTS_PER_PAGE
                document.getElementById('paginationControls').style.display = 'none';
            }

            // --- Render Komentar ---
            commentsToDisplay.forEach((mainC) => {
                let mainDiv = document.createElement('div');
                mainDiv.className = "commentItem";
                mainDiv.id = `comment-${mainC.id}`;

                const replies = allComments
                    .filter(r => r.parentId === mainC.id)
                    .sort((a, b) => new Date(a.time) - new Date(b.time));
                
                let mainContent = `
                    <div style="direction: ltr; text-align: left;">
                        <b>${mainC.name}</b> (${mainC.status})<br>
                        ${mainC.msg}
                        <div class="timeInfo">
                            <button class="replyBtn" data-id="${mainC.id}" data-name="${mainC.name}">Balas</button>
                            <span class="comment-time">${mainC.time}</span>
                        </div>
                    </div>
                    <div class="reply-list" id="replies-for-${mainC.id}">
                        ${replies.map(r => `
                            <div class="reply-item">
                                <b>${r.name}:</b>
                                <span class="reply-text">${r.msg}</span>
                                <div class="timeInfo">${r.time}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="reply-form" id="replyForm-${mainC.id}">
                        <div class="formLabel">Nama</div>
                        <input type="text" id="rName-${mainC.id}" placeholder="Nama Anda">
                        <div class="formLabel">Komen</div>
                        <textarea id="rMsg-${mainC.id}" placeholder="Balasan untuk ${mainC.name}..."></textarea>
                        <button class="sendReplyBtn" data-parent-id="${mainC.id}" data-parent-name="${mainC.name}">Kirim</button>
                    </div>
                `;
                mainDiv.innerHTML = mainContent;
                commentsList.appendChild(mainDiv);
            });

            // Pasang kembali event listeners untuk elemen yang baru dirender
            attachEventListeners();
        }

        /**
         * 4. Memasang Event Listeners
         */
        function attachEventListeners() {
            // Listener untuk tombol "Balas"
            document.querySelectorAll('.replyBtn').forEach(btn => {
                btn.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const replyForm = document.getElementById(`replyForm-${id}`);

                    // Sembunyikan semua form balasan yang terbuka
                    document.querySelectorAll('.reply-form').forEach(form => {
                        if (form.id !== replyForm.id) {
                            form.style.display = 'none';
                        }
                    });

                    // Toggle form balasan yang diklik
                    replyForm.style.display = replyForm.style.display === 'block' ? 'none' : 'block';
                };
            });

            // Listener untuk tombol "Kirim Balasan"
            document.querySelectorAll('.sendReplyBtn').forEach(btn => {
                btn.onclick = async (e) => {
                    const parentId = e.target.dataset.parentId;
                    const nameInput = document.getElementById(`rName-${parentId}`);
                    const msgInput = document.getElementById(`rMsg-${parentId}`);

                    let name = nameInput.value.trim();
                    let msg = msgInput.value.trim();

                    if (!name || !msg) {
                        alert("Harap masukkan Nama dan Komen untuk membalas.");
                        return;
                    }

                    const replyData = {
                        name,
                        msg,
                        status: 'Balasan',
                        parentId: parentId,
                    };
                    
                    await addCommentToSheet(replyData);
                    
                    // Bersihkan dan sembunyikan form
                    nameInput.value = "";
                    msgInput.value = "";
                    document.getElementById(`replyForm-${parentId}`).style.display = 'none';
                };
            });
        }
        
        /**
         * 5. Pengiriman Komentar Utama
         */
        sendComment.onclick = async () => {
            let name = cName.value.trim();
            let msg = cMsg.value.trim();
            let st = cStatus.value;

            if (!name || !st) {
                alert("Harap masukkan nama dan Status Kehadiran.");
                return;
            }

            const mainCommentData = {
                name,
                msg,
                status: st,
                parentId: ""
            };
            
            await addCommentToSheet(mainCommentData);
            
            // Bersihkan form
            cName.value = "";
            cMsg.value = "";
            cStatus.value = "";
        };

        /** 游릭 LOGIKA NAVIGASI PAGINASI 游릭 */
        // Tombol Sebelumnya
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderComments();
                // Opsional: Gulir ke atas daftar komentar
                commentsList.closest('#commentsWrapper').scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Tombol Berikutnya
        nextBtn.onclick = () => {
            const totalMainComments = allComments.filter(c => !c.parentId || c.parentId === 'null' || c.parentId === '').length;
            const totalPages = Math.ceil(totalMainComments / COMMENTS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderComments();
                // Opsional: Gulir ke atas daftar komentar
                commentsList.closest('#commentsWrapper').scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        /** ----------------------------- */

        /**
         * 6. Inisialisasi: Memuat data awal
         */
        async function initComments() {
            await getCommentsFromSheet();
            renderComments();
        }

        // Panggil inisialisasi saat halaman dimuat
        initComments();
    </script>

</body>
</html>